<script type="text/html" data-template-name="tuya device">
    <div class="form-row">
	    <label for="node-input-accounte"><i class="fa fa-cog"></i> Tuya Account</label>
	    <input type="text" id="node-input-account" >
    </div>
    <div class="form-row">
	    <label for="node-input-device"><i class="fa fa-cog"></i> Device</label>
	    <input type="text" id="node-input-device" >
    </div>
</script>

<script type="text/javascript">
  /* global RED, $ */
  /* eslint no-undef: "error" */
  let alldevices = {};

  RED.nodes.registerType('tuya device', {
    category: 'tuya',
    color: '#ffffff',
    defaults: {
      account: { value: '', type: 'tuya config' },
      deviceid: { value: '', required: true },
      devicekey: { value: '', required: false },
      devicename: { value: '', required: false },
    },
    inputs: 1,
    outputs: 2,
    icon() { return 'tuya.svg'; },
    label() { return this.devicename; },
    oneditsave() {
      this.deviceid = $('#node-input-device').typedInput('value');
      this.devicekey = alldevices[this.deviceid].devicekey;
      this.devicename = alldevices[this.deviceid].devicename;
    },
    oneditprepare() {
      $.getJSON(`tuyadevices/${this.account}`, (data) => {
        alldevices = data;

        const deviceoptions = [];
        const keys = Object.keys(alldevices);
        for (let i = 0; i < keys.length; i += 1) {
          const key = keys[i];
          const device = alldevices[key];
          const option = { value: key, label: device.devicename };
          deviceoptions.push(option);
        }

        $('#node-input-device').typedInput({
          types: [
            {
              value: 'device',
              options: deviceoptions,
            },
          ],
        });
      });
    },
  });
</script>


<script type="text/html" data-help-name="tuya device">
<p>A Tuya device.</p>
</script>
